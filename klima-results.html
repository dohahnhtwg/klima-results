<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="/bower_components/range-slider/range-slider.html">
<link rel="import" href="/bower_components/klima-results-cache/klima-results-cache.html">
<link rel="import" href="/bower_components/google-chart/google-chart.html">
<link rel="import" href="/bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="/bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="/bower_components/paper-item/paper-item.html">
<link rel="import" href="/bower_components/iron-flex-layout/iron-flex-layout-classes.html">

<!--
`klima-results`
result view for klima application

@demo demo/index.html
-->

<dom-module id="klima-results">
  <template>
    <style include="iron-flex">
      :host {
        display: block;
      }
      #choicesContainer {
        @apply(--layout-horizontal);
      }
      .choice {
        min-width: 200px;
        margin: 5px;
      }
      #chart {
        margin: 20px;
        width: 600px;
      }
      #rangeSlider {
        width: 600px;
      }
      .listboxes {
        max-height: 500px;
      }
      .items {
        --paper-item-min-height: {
          width: 10px;
        };
      }
    </style>
    <!-- on-tap="_domainChanged"  on-tap="_departmentChanged" on-tap="_pointsOfInterstChanged"-->
    <div style="width: 200px">
      <div id="choicesContainer">
        <paper-dropdown-menu class="choice" label="Bereich">
          <paper-listbox id="domainListbox" class="dropdown-content listboxes" selected="{{selectedDomain}}" attr-for-selected="value">
            <template id="domainTemplate" is="dom-repeat" items="{{domains}}">
              <paper-item class="items" value="{{item}}">{{item.name}}</paper-item>
            </template>
          </paper-listbox>
        </paper-dropdown-menu>
        <paper-dropdown-menu class="choice" label="Abteilung">
          <paper-listbox id="departmentListbox" class="dropdown-content listboxes" selected="{{selectedDepartment}}" attr-for-selected="value">
            <template id="departmentTemplate" is="dom-repeat" items="{{departments}}">
              <paper-item class="items" value="{{item}}">{{item.name}}</paper-item>
            </template>
          </paper-listbox>
        </paper-dropdown-menu>
        <paper-dropdown-menu class="choice" label="Wert">
          <paper-listbox id="valueListbox" class="dropdown-content listboxes" selected="{{selectedValue}}" attr-for-selected="value">
            <template id="valueTemplate" is="dom-repeat" items="{{values}}">
              <paper-item class="items" value="{{item}}">{{item.name}}</paper-item>
            </template>
          </paper-listbox>
        </paper-dropdown-menu>
    </div>
    <google-chart id="chart"
      type='md-line'>
    </google-chart>
    <div>Perioden</div>
    <range-slider id="rangeSlider" min="0" max="10" editable></range-slider>
  </template>

  <script>
    Polymer({
      is: 'klima-results',
      behaviors: [KlimaResultsBehavior],
      properties: {
        domains: {
          type: Array,
          notify: true,
        },
        departments: {
          type: Array,
          observer: '_departmentsChanged',
          notify: true,
        },
        values: {
          type: Array,
          observer: '_valuesChanged',
          notify: true,
        },
        selectedDomain: {
          type: Object,
          observer: '_domainChanged'
        },
        selectedDepartment: {
          type: Object,
          observer: '_departmentChanged'
        },
        selectedValue: {
          type: Object,
          observer: '_valueChanged'
        }
      },

      ready: function() {
        this.selectedDomain = domains[0];
        console.log(this.$.chart.options);
      },

      _domainChanged: function(e) {
        this.departments = e.departments;
        this.selectedDepartment = this.departments[0];
      },

      _departmentChanged: function(e) {
        if(e == null) return;
        this.values = e.values;
        this.selectedValue = null;
        this.selectedValue = this.values[0];
      },

      _valueChanged: function(e) {
        if(e == null) return;
        this.getChartData(this.selectedValue.key, this.selectedDomain.key, this.selectedDepartment.key, function(chartData) {
            this.$.chart.cols = null;
            this.$.chart.rows = null;
            this.$.chart.cols = chartData.cols;
            this.$.chart.rows = chartData.rows;
            this.$.chart.options = {chart: {title: this.selectedValue.name}, colors: ['red', 'blue']}
            this.$.chart.redraw();
        }.bind(this));
      },
      _departmentsChanged: function(e) {
        this._forceDropDownUpdate(this.$.departmentListbox,
          this.$.departmentTemplate, this.departments);
      },
      _valuesChanged: function(e) {
        this._forceDropDownUpdate(this.$.valueListbox,
          this.$.valueTemplate, this.values);
      },
      _forceDropDownUpdate: function(listbox, listboxTemplate, items) {
        // workaround for issue: https://github.com/PolymerElements/paper-dropdown-menu/issues/197
        let selected = listbox.indexOf(listbox.selected);
        listbox.selectIndex(-1); // Clear selection
        if (selected < items.length) {
          listboxTemplate.render();
          listbox.forceSynchronousItemUpdate();
          listbox.selectIndex(selected);
        }
      }
    });
  </script>
</dom-module>
